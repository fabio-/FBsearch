<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

	<div style="background-color:#3b5998; width:100%;height:100px;">
    	<div id="header"><img id="logo" src="FacebookSearch.png"></div>
    </div>
    
    <div id="mainArea">
    	<h1>To Search for events in your city enter your location in the searach bar!</h1>
	
   		<div id="searchBar">
    		<input type="text" name="q" id="q"/>
           	<input type="submit" class="go"â€‹ value="Press"/>
        </div>
        <div id="loading"></div>
   	 </div>
    
    <div id="wrapper">
   		<div id="content"> </div>
    </div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<script type="text/javascript">

//Handle the "enter" event to trigger button click
$("#q").keyup(function(event){
    if(event.keyCode == 13){
        $('.go').click();
    }
});

$('.go').click(function() {
	
	//set number of results(events) in the json object 
	var limit = 5000;
	var start = (new Date).getTime();
	var diff = 0;
	
	//removes previous searches!
	$('#content').empty();
	$('#loading').empty();
	
	$('#loading').append( '<p>Loading Results:</p><img src="loading.gif" id="loadImage">');
	var accessToken = getAccessToken();

	//query the Facebook graph search with input parameters and valid access token
    var url = 'https://graph.facebook.com/search?q='+ $('#q').val()+'&type=event&limit='+limit+'&'+accessToken;

	getJson(url);	
						
	$('#content').append('<br><br>');
	$('.go').val("Search");
	
	
	function getAccessToken(){
		var requestURL = 'https://graph.facebook.com/oauth/access_token?%20client_id=136237449885255&client_secret=9f9191c07c175024dbc495c7914625c0&%20grant_type=client_credentials';
	
		var accessToken = $.ajax({
  		url: requestURL,
  		global: false,
  		type: "POST",
  		data: "name=value",
  		dataType: "html",
  		async:false,
  		success: function(msg){ }
		} ).responseText;
		
		return accessToken;
	}
	
	//retrieves and stores events in a json object
	function getJson(url){
		var jsonEvents = {};
    	$.ajax({
    		url: url,
    		dataType: 'json',
    		success: function(data) {
    				jsonEvents = data.data;
					
					if(jsonEvents.length == 0){
						displayZeroResult();
					}
					
					
					buildRanking(jsonEvents);
    		}
    	});
	}
	
	
	//Create the HTML to display every single event
	function addResults(jsonEvents){
		
		var events = 10;
		
		if(jsonEvents.length <10){
			events=jsonEvents.length;
		}
		
		for(var key=0 ; key<events ; key++){
			var name = jsonEvents[key].name;
			var date = jsonEvents[key].start_date;
			
			if(name.length>45){
				name = name.substring(45);
			}
				
			console.log(date);
			
			var out = '<div class="multiborder">'+
			'<img id="proPic" src="https://graph.facebook.com/'+jsonEvents[key].id+'/picture?type=large">'+
			'<div id="event1" ><a href=https://www.facebook.com/events/'+jsonEvents[key].id+'><b>'+name.toLowerCase()+'</b></a></div>'+
			'<div id="info" >'+jsonEvents[key].location+'</div>'+
			'<div id="info" >Going:'+jsonEvents[key].likes+'</div>'+
			'<div id="sideTxt"><img class="icon" src="location.png">'+jsonEvents[key].location+'</div></div>';
											
        	$('#content').append(out);
			$('#content').append('<br>');
		}
	}
	
	function buildRanking(jsonEvents){
		
		var count=0;
		
		Object.keys(jsonEvents).forEach(function(key){
			
			var url = 'https://graph.facebook.com/'+jsonEvents[key].id+'/attending?'+accessToken;
			
			$.ajax({
   			url: url,
   			dataType: 'json',
   			success: function(data) {
					 	likes = data.data.length;
						
						//add number of likes to the Json object representing events
						jsonEvents[key].NewItem='likes';
						jsonEvents[key].likes=likes;
			
						count = count+1;
						
						//Perform sort on number of likes once they are all added to the json
						if(count==jsonEvents.length){
								jsonEvents = removeDuplicates(jsonEvents);
								jsonEvents.sort(function(a, b){
    												return b.likes - a.likes;
												});
								addResults(jsonEvents);
								diff = (new Date).getTime() - start;
								diff/=1000;
								diff.toString().substring(3);
								$('#loading').empty();
								$('#loading').append("<p>"+jsonEvents.length+" events in about : "+diff+" seconds</p>");
						}
					  }  //close success function
    		});  //close ajax to retrieve likes
			
		});  //close loop on each event
	}  //close buildRanking function
	
	//sort events alphabetically based on name
	function sortEvents(json){
		var imin = 0;
		
		for(var j=0 ; j<json.length ; j++){
			imin = j
			for(var i=j+1 ; i<json.length ; i++){
				if (json[i].name < json[imin].name) {
					imin = i;
				}
			}
			if ( imin != j ) {
				var temp = json[imin];
				json[imin] = json[j];
				json[j] = temp;
			}	
		}
		return json;
	} //close of sortEvents
	
	//return a json array containing only events with different names, taking into account ones that have more likes
	function removeDuplicates(json){
		newjson=[];
		json = sortEvents(json);
		var i=0;
		var j=0;
		var k=i+1;
		var maxLikes = 0;
		for( i; i<json.length-1 ; i++){
			if(json[i].name.toLowerCase() != json[k].name.toLowerCase()){
				if(json[i].likes > json[maxLikes].likes){
					newjson[j]=json[i];
				}else{
					newjson[j]=json[maxLikes];
				}
				maxLikes=k;
				j++;
				k++;
			}else{
				if(json[i].likes > json[k].likes){ 
					maxLikes = i; 
				}
				k++;
			}
		}
		console.log(newjson);
		return newjson;
	}
	
	function displayZeroResult(){
		diff = (new Date).getTime() - start;
		diff/=1000;
		diff.toString().substring(3);
		$('#loading').empty();
		$('#loading').append("<p>Zero events found in about : "+diff+" seconds</p>");
	}

});


</script>
</body>
</html>