<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

	<div style="background-color:#3b5998; width:100%;height:100px;">
    	<div id="header"><img id="logo" src="FacebookSearch.png"></div>
    </div>
    
    <div id="mainArea">
    	<h1>To Search for events in your city enter your location in the searach bar!</h1>
	
   		<div id="searchBar">
    		<input type="text" name="q" id="q"/>
           	<input type="submit" class="go"â€‹ value="Press"/>
        </div>
        <div id="loading"></div>
   	 </div>
    
    <div id="wrapper">
   		<div id="content"> </div>
    </div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<script type="text/javascript">

//Handle the "enter" event to trigger button click
$("#q").keyup(function(event){
    if(event.keyCode == 13){
        $('.go').click();
    }
});


$('.go').click(function() {
	
	//set number of results(events) in the json object 
	var limit = 5000;
	var start = (new Date).getTime();
	var diff = 0;
	
	//removes previous searches!
	$('#content').empty();
	$('#loading').empty();
	
	$('#loading').append( '<p>Loading Results:</p><img src="loading.gif" id="loadImage">');
	var accessToken = getAccessToken();

	//query the Facebook graph search with input parameters and valid access token
    var url = 'https://graph.facebook.com/search?q='+ $('#q').val()+'&type=event&limit='+limit+'&'+accessToken;

	getJson(url);	
						
	$('#content').append('<br><br>');
	$('.go').val("Search");
	
	
	function getAccessToken(){
		var requestURL = 'https://graph.facebook.com/oauth/access_token?%20client_id=136237449885255&client_secret=9f9191c07c175024dbc495c7914625c0&%20grant_type=client_credentials';
	
		var accessToken = $.ajax({
  		url: requestURL,
  		global: false,
  		type: "POST",
  		data: "name=value",
  		dataType: "html",
  		async:false,
  		success: function(msg){ }
		} ).responseText;
		
		return accessToken;
	}
	
	//retrieves and stores events in a json object
	function getJson(url){
		var jsonEvents = {};
    	$.ajax({
    		url: url,
    		dataType: 'json',
    		success: function(data) {
    				jsonEvents = data.data;
					
					if(jsonEvents.length == 0){
						displayZeroResult();
					}
					
					
					buildRanking(jsonEvents);
    		}
    	});
	}
	
	
	//Create the HTML to display every single event
	function addResults(jsonEvents){
		
		var events = 10;
		var time = "Not Provided";
		var timezone = "Not Provided";
		var location = "Not Provided"
		
		if(jsonEvents.length <10){
			events=jsonEvents.length;
		}
		
		for(var key=0 ; key<events ; key++){
			var name = jsonEvents[key].name;
			var date = jsonEvents[key].start_time;
			
			if(name.length>45){
				name = name.substring(45);
			}
			
			var dateNTime = splitDateNTime(date);
			
			console.log(date);
			console.log(dateNTime[0]);
			var timeZone = jsonEvents[key].timezone;
			if(dateNTime[1]!=1){
				time = dateNTime[1];
			}
			if(jsonEvents[key].timezone != undefined){
				timezone = jsonEvents[key].timezone;
				}
			
			if(jsonEvents[key].location != undefined){
				location = jsonEvents[key].location;
				}
				
			var out = '<div class="multiborder"><div class="evnt"><a href=https://www.facebook.com/events/'+jsonEvents[key].id+'><b>'+name+'</b></a></div><div class= imgDiv><div id = "proPic">'+
			'<img src="https://graph.facebook.com/'+jsonEvents[key].id+'/picture?type=large "height="110" width="159"></div></div>'+
			'<div id="event1" ><div id="innerEvent"><div id = "iconStyle"><img class="icon" src="date.png"></div>'+
			'<div id="startTimeStyle">'+dateNTime[0]+'</div></div>'+
			'<div id ="innerEvent2"><div id = "iconStyle"><img class="icon" src="time.png"></div>'+
			'<div id = "startTimeStyleBig">Starts at -> '+time+' </div></div>'+
			'<div id = "event2"><div id = innerEvent><div id = "startTimeStyleBig"> Going-> <b>'+jsonEvents[key].likes+'</b> persons</div></div>'+
			'<div id = "innerEvent2"><div id = "iconStyle"><img class="icon" src="timezone-icon.jpg"></div>'+
			'<div id = "startTimeStyleBig">'+timezone+'</div></div>'+
			//'<div id="info" >Going:'+jsonEvents[key].likes+'</div>'+
			'<div id = "event2"><div id = "innerEvent3"><div id = "iconStyle"><img class="icon" src="location.png"></div>'+
			'<div id = "locationStyle">'+location+'</div></div>';
			
			//'<div id="event2"><div id="innerEvent2"><div id = "iconeStyle"><img class="icon" src="location.png"></div><div id = "startTimeStyleBig">'+jsonEvents[key].location+'</div></div></div></div>';
			
        	$('#content').append(out);
			$('#content').append('<br>');
		}
	}
	
	function buildRanking(jsonEvents){
		
		var count=0;
		
		Object.keys(jsonEvents).forEach(function(key){
			
			var url = 'https://graph.facebook.com/'+jsonEvents[key].id+'/attending?'+accessToken;
			
			$.ajax({
   			url: url,
   			dataType: 'json',
   			success: function(data) {
					 	likes = data.data.length;
						
						//add number of likes to the Json object representing events
						jsonEvents[key].NewItem='likes';
						jsonEvents[key].likes=likes;
			
						count = count+1;
						
						//Perform sort on number of likes once they are all added to the json
						if(count==jsonEvents.length){
								jsonEvents = removeDuplicates(jsonEvents);
								jsonEvents.sort(function(a, b){
    												return b.likes - a.likes;
												});
								addResults(jsonEvents);
								diff = (new Date).getTime() - start;
								diff/=1000;
								diff.toString().substring(3);
								$('#loading').empty();
								$('#loading').append("<p>"+jsonEvents.length+" events in about : "+diff+" seconds</p>");
						}
					  }  //close success function
    		});  //close ajax to retrieve likes
			
		});  //close loop on each event
	}  //close buildRanking function
	
	//sort events alphabetically based on name
	function sortEvents(json){
		var imin = 0;
		
		for(var j=0 ; j<json.length ; j++){
			imin = j
			for(var i=j+1 ; i<json.length ; i++){
				if (json[i].name < json[imin].name) {
					imin = i;
				}
			}
			if ( imin != j ) {
				var temp = json[imin];
				json[imin] = json[j];
				json[j] = temp;
			}	
		}
		return json;
	} //close of sortEvents
	
	//return a json array containing only events with different names, taking into account ones that have more likes
	function removeDuplicates(json){
		newjson=[];
		json = sortEvents(json);
		var i=0;
		var j=0;
		var k=i+1;
		var maxLikes = 0;
		for( i; i<json.length-1 ; i++){
			if(json[i].name.toLowerCase() != json[k].name.toLowerCase()){
				if(json[i].likes > json[maxLikes].likes){
					newjson[j]=json[i];
				}else{
					newjson[j]=json[maxLikes];
				}
				maxLikes=k;
				j++;
				k++;
			}else{
				if(json[i].likes > json[k].likes){ 
					maxLikes = i; 
				}
				k++;
			}
		}
		console.log(newjson);
		return newjson;
	}
	
	function displayZeroResult(){
		diff = (new Date).getTime() - start;
		diff/=1000;
		diff.toString().substring(3);
		$('#loading').empty();
		$('#loading').append("<p>Zero events found in about : "+diff+" seconds</p>");
	}
	 //Takes Date and time together and split them and return them as an array
	function splitDateNTime(timeDate){
		
		var actualTime;
		var actualDate;
		
		var timeDateSplited = new Array();
		try{		
			timeDateSplited = timeDate.split("T");
		
			var date = timeDateSplited[0].split("-");
			var time = timeDateSplited[1].split(":");
		
			if(time[0]>12){
			
				var t = time[0] - 12;
				actualTime = t+":"+time[1]+" pm       ";
			}else{
				actualTime= time[0]+":"+time[1]+" am";
			}
		
			var month = getMonthName(date[1]);
		
			actualDate = month+" "+date[2]+","+date[0];
		
			var returnArray= [actualDate,actualTime];
		
			return returnArray;
		}catch(err){
			var date = timeDateSplited[0].split("-");
			
			var month = getMonthName(date[1]);
		
			actualDate = month+" "+date[2]+","+date[0];
			return [actualDate,1];
			}
	}
	//This function fwill take a number and convert it as a Month
	function getMonthName(monthAsNumber){
		
		if(monthAsNumber == 1){
			return "Jan";
		} else if(monthAsNumber == 2){
			return "Feb";
		}else if(monthAsNumber == 3){
			return "March";
		}else if(monthAsNumber == 4){
			return "April";
		}else if(monthAsNumber == 5){
			return "May";
		}else if(monthAsNumber == 6){
			return "June";
		}else if(monthAsNumber == 7){
			return "July";
		}else if(monthAsNumber == 8){
			return "Aug";
		}else if(monthAsNumber == 9){
			return "Sep";
		}else if(monthAsNumber == 10){
			return "Oct";
		}else if(monthAsNumber = 11){
			return "Nov";
		}else{
			return "Dec";
			}
		
	}

});
/*
var out = '<div class="multiborder"><div class="evnt"><a href=https://www.facebook.com/events/'+jsonEvents[key].id+'><b>'+name+'</b></a></div><div class= imgDiv><div id = "proPic">'+
			'<img src="https://graph.facebook.com/'+jsonEvents[key].id+'/picture?type=large "height="120" width="159"></div></div>'+
			'<div id="event1" ><div id="innerEvent"><div id = "iconStyle"><img class="icon" src="date.png"></div>'+
			'<div id="startTimeStyle">'+dateNTime[0]+'</div></div>'+
			'<div id ="innerEvent2"><div id = "iconStyle"><img class="icon" src="time.png"></div>'+
			'<div id = "startTimeStyle"> '+time+' </div></div>'+
			'<div id="info" >'+jsonEvents[key].timezone+'</div>'+
			'<div id="info" >Going:'+jsonEvents[key].likes+'</div>'+
			'<div id="sideTxt"><img class="icon" src="location.png">'+jsonEvents[key].location+'</div></div>';
*/
</script>
</body>
</html>